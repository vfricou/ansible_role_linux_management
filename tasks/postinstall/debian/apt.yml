---
- name: "Postinstall | Debian | Apt | Update local cache"
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 7200
  tags:
    - always

- name: "Postinstall | Debian | Apt | Get packages facts"
  ansible.builtin.package_facts:
  tags:
    - always

- name: "Postinstall | Debian | Apt | Lock kernel packages"
  ansible.builtin.dpkg_selections:
    name: '{{ item }}'
    selection: hold
  with_items:
    - "{{ ansible_facts.packages.keys() | list | map('regex_search', v_debian['exclusions']) | select('string') }}"
  tags:
    - safeupgrade

- name: "Postinstall | Debian | Apt | Unlock kernel packages"
  ansible.builtin.dpkg_selections:
    name: '{{ item }}'
    selection: install
  with_items:
    - "{{ ansible_facts.packages.keys() | list | map('regex_search', v_debian['exclusions']) | select('string') }}"
  tags:
    - fullupgrade

- name: "Postinstall | Debian | Apt | Perform full upgrade"
  ansible.builtin.apt:
    upgrade: full
  environment:
    ACCEPT_EULA: y
  tags:
    - fullupgrade

- name: "Postinstall | Debian | Apt | Perform upgrade without kernel"
  ansible.builtin.apt:
    upgrade: safe
  environment:
    ACCEPT_EULA: y
  tags:
    - safeupgrade
